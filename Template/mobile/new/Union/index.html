<!DOCTYPE html >
<html>
<head>
    <meta name="Generator" content="gjshop v1.1" />
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width">
    <title>发现-{$gjshop_config['shop_info_store_title']}</title>
    <meta http-equiv="keywords" content="{$gjshop_config['shop_info_store_keyword']}" />
    <meta name="description" content="{$gjshop_config['shop_info_store_desc']}" />
    <meta name="viewport" content="initial-scale=1.0, maximum-scale=1.0, user-scalable=0"/>
    <link rel="stylesheet" type="text/css" href="__STATIC__/css/public.css"/>
    <link rel="stylesheet" type="text/css" href="__STATIC__/css/index.css"/>
    <link rel="stylesheet" type="text/css" href="__STATIC__/IconFont/iconfont.css"/>
    <link href="__PUBLIC__/bootstrap/css/font-awesome.min.css" rel="stylesheet" type="text/css" />
    <script type="text/javascript" src="__STATIC__/js/jquery.js"></script>
    <script type="text/javascript" src="__STATIC__/js/TouchSlide.1.1.js"></script>
    <script type="text/javascript" src="__STATIC__/js/jquery.json.js"></script>
    <script type="text/javascript" src="__STATIC__/js/touchslider.dev.js"></script>
    <script type="text/javascript" src="__STATIC__/js/layer.js" ></script>
    <script src="__PUBLIC__/js/global.js"></script>
    <script src="__PUBLIC__/js/mobile_common.js"></script>
</head>
<body>
    <div id="page" class="showpage">
        <div>
            <div id="scrollimg" class="scrollimg">
                <div class="bd">
                    <ul>
                        <adv pid ="2" limit="5" item="v">
                            <li>
                                <a href="{$v.ad_link}" <if condition="$v['target'] eq 1">target="_blank"</if>
                                >
                                    <img src="{$v[ad_code]}" title="{$v[title]}"width="100%" style="{$v[style]}"/>
                                </a>
                            </li>
                        </adv>
                    </ul>
                </div>
                <div class="hd">
                    <ul></ul>
                </div>
            </div>
            <script type="text/javascript">
                TouchSlide({
                    slideCell:"#scrollimg",
                    titCell:".hd ul", //开启自动分页 autoPage:true ，此时设置 titCell 为导航元素包裹层
                    mainCell:".bd ul",
                    effect:"leftLoop",
                    autoPage:true,//自动分页
                    autoPlay:true //自动播放
                });
            </script>
        </div>
    </div>

<style>

    .icon-wrapper {
        margin: 10px 0;
        padding: 10px 0;
        box-shadow: 0px 5px 7px rgb(216, 216, 216);
        margin-top: 5px;
        padding-bottom: 5px;
    }

    .icon-list li {
        width: 25%;
        float: left;
        display: inline-block;
        text-align: center;
    }

    .icon-list .icon {
        display: block;
        font-size: 2.8rem;
        color: #fff;
        background-color: #1E909C;
        width: 3.8rem;
        height: 3.8rem;
        line-height: 3.8rem;
        text-align: center;
        margin: 0 auto;
        border-radius: 50%;
    }

    .icon-list .icon-desc {
        display: block;
        color: #333;
        font-size: 1.2rem;
    }
    .icon-list li:nth-child(5+n) {
        margin-top: 10px;
    }
</style>

<div class="icon-wrapper">
    <ul class="icon-list">
        <li>
            <a href="javascript:void(0);" data-cat="0">
                <i class="icon iconfont icon-meishi" style="background: #fd9d21;    box-shadow: 0px 1px 3px #fd9d21;"></i>
                <span class="icon-desc">美食</span>
            </a>
        </li>
        <li>
            <a href="javascript:void(0);" data-cat="1">
                <i class="icon iconfont icon-dianying" style="    background: #ff6767;    box-shadow: 0px 1px 3px #ff6767;"></i>
                <span class="icon-desc">电影</span>
            </a>
        </li>
        <li>
            <a href="javascript:void(0);" data-cat="2">
                <i class="icon iconfont icon-jiudianicon" style="background: #8a90fa;    box-shadow: 0px 1px 3px #8a90fa;"></i>
                <span class="icon-desc">酒店</span>
            </a>
        </li>
        <li>
            <a href="javascript:void(0);" data-cat="3">
                <i class="icon iconfont icon-xiuxian-copy" style="    background-color: #BF5CFD;    box-shadow: 0px 1px 3px #BF5CFD;"></i>
                <span class="icon-desc">休闲娱乐</span>
            </a>
        </li>
        <li>
            <a href="javascript:void(0);" data-cat="4">
                <i class="icon iconfont icon-zuliao" style="background-color: #FD58B4;    box-shadow: 0px 1px 3px #FD58B4;"></i>
                <span class="icon-desc">足疗按摩</span>
            </a>
        </li>
        <li>
            <a href="javascript:void(0);" data-cat="5">
                <i class="icon iconfont icon-ktv" style="    background-color: #7D68F5;    box-shadow: 0px 1px 3px #7D68F5;"></i>
                <span class="icon-desc">KTV</span>
            </a>
        </li>
        <li>
            <a href="javascript:void(0);" data-cat="6">
                <i class="icon iconfont icon-liren" style="    background: #ff80c2;    box-shadow: 0px 1px 3px #ff80c2;"></i>
                <span class="icon-desc">丽人</span>
            </a>
        </li>
        <li>
            <a href="javascript:void(0);" data-cat="7">
                <i class="icon iconfont icon-gengduo" style="background: #00d3be;    box-shadow: 0px 1px 3px #00d3be;"></i>
                <span class="icon-desc">其他</span>
            </a>
        </li>
        <div class="clear"></div>
    </ul>
</div>


<style>
    #guessLike {
        margin: 20px 0;
    }
    #guessLike .title {
        border-left: 5px #1E909C solid;
        padding-left: 10px;
        margin-left: 4px;
        height: 20px;
        font-size: 1.8rem;
        line-height: 20px;
    }
    #guessLike .dealcard {
        margin: 10px 0;
        overflow: hidden;
    }

    #guessLike .dealcard-img {
        height: 160px;
        width: 160px;
        position: absolute;
    }

    #guessLike .dealcard-block-right {
        margin-left: 172px;
        height: 160px;
    }
    #guessLike .more {
        text-align: center;
    }

    #guessLike .dealcard-brand {
        font-size: 1.6rem;
    }

    #guessLike .seller-item {
        margin: 10px 0;
        box-shadow: 1px 2px 12px rgb(216, 216, 216);
    }
    #guessLike .local {
        color: red;
    }

    #getmore a {
        display: block;
        text-align: center;
    }
    #positioning {
        color: #FFFFFF;
        font-size: 1.3rem;
        margin-left: 10px;
        background-color: #00D3BE;
        padding: 1px 7px;
        border-radius: 9px;
    }
    #positioning i {
        margin-left: 5px;
    }
</style>

<div id="guessLike" class="guess-like">
    <dl class="list" style="opacity: 1;">
        <dd>
            <dl class="list" id="ajax_return" style="opacity: 1;">
                <dt class="title">附近商家<span id="positioning"><i class="fa fa-refresh fa-spin"></i>&nbsp;&nbsp;正在定位…</span></dt>
                <dd id="get_more_load">
                    <a href="javascript:;" style="text-align:center; display:block;">
                        <img src="__STATIC__/images/category/loader.gif" width="12" height="12">
                    </a>
                </dd>
                <dd id="getmore" style="display: none;"><a href="javascript:void(0)" onclick="getSeller()">查看更多</a></dd>
            </dl>
        </dd>
    </dl>
</div>


<!-- 这个先加载，渲染比较好，不然要慢慢最后才显示，体验会不好的 -->
<include file="Public/footer_nav"/>

<script>
    var Local = {longitude:0, latitude:0};
    var cat = 0;
    $(function(){

        // 定位
        if(typeof wx != "undefined") {

            $('#positioning').click(function() {
                getWxLocation(callback);
            });

            wx.ready(function(){
                // 微信定位接口
                getWxLocation(callback);
            });
        } else {

            $('#positioning').click(function() {
                getLocation(callback);
            });

            // 普通定位接口
            getLocation(callback);
        }

        $('.icon-list li a').click(function() {
            $('.seller-item').empty();
            cat = $(this).data('cat');
            getSeller();
        });
    });

    // 定位之后的回调
    function callback() {
        // 拉取商家列表
        getSeller();
        // 获取地理位置名称
        getLocalName('wgs84ll', callback2);
    }

    // 获取到地理位置之后的回调
    function callback2(result) {
        console.log(result);
        $('#positioning').text(result.result.formatted_address);
    }

    // 微信定位
    function getWxLocation(callback) {
        layer.open({content: '<i class="fa fa-refresh fa-spin"></i>&nbsp;&nbsp;正在定位…'});
        $('#positioning').html('<i class="fa fa-refresh fa-spin"></i>&nbsp;&nbsp;正在定位…');

        wx.getLocation({
            type: 'wgs84', // 默认为wgs84的gps坐标，如果要返回直接给openLocation用的火星坐标，可传入'gcj02'
            success: function (res) {
                Local.latitude = res.latitude; // 纬度，浮点数，范围为90 ~ -90
                Local.longitude = res.longitude; // 经度，浮点数，范围为180 ~ -180。
                Local.speed = res.speed; // 速度，以米/每秒计
                Local.accuracy = res.accuracy; // 位置精度
                console.log(Local);
            },
            fail: function (errMsg) {
                console.log(errMsg);
            },
            complete: function () {
                console.log('Local to complete');
                callback();
            },
            cancel: function () {
                alert('you cancel getLocation');
            }
        });
    }

    // 普通定位
    function getLocation(callback) {
        layer.open({content: '<i class="fa fa-refresh fa-spin"></i>&nbsp;&nbsp;正在定位…'});
        $('#positioning').html('<i class="fa fa-refresh fa-spin"></i>&nbsp;&nbsp;正在定位…');

        getLocationApi(function (position) {
            Local.longitude = position.coords.longitude;
            Local.latitude = position.coords.latitude;
        });
    }

    // 根据坐标获取地理位置名称
    function getLocalName(coordtype, callback2) {
        var lat_lng = Local.latitude + ',' + Local.longitude;
        if (!coordtype) coordtype = 'wgs84ll';
        $.getJSON('http://api.map.baidu.com/geocoder/v2/?callback=?', {'ak':'9Go7FByT2xPEH5VcPKMiZWoY', 'location':lat_lng, 'coordtype':coordtype, 'output':'json', 'pois':0}, function(result) {
                if (result.status == 0) {
                    callback2(result);
                    layer.open({
                        content: '猜你在：<font color=red>'+result.result.formatted_address+'</font>',
                        btn: ['嗯嗯，是的', '错了，笨蛋'],
                        yes: function(index){
                            layer.close(index);
                        },
                        no: function(index){
                            layer_no();
                        },
                    });
                } else {
                    layer.open({content: '<i class="fa fa-exclamation-triangle"></i>&nbsp;哎呀妈，暂无法获取您的位置。'});
                }
            }
        );
    }

    function getSeller() {
        $('#getmore').hide();
        $('#get_more_load').show();
        var url = "{:U('getShopList')}";
        $.ajax({
            type : "GET",
            url  : url + '?cat=' + cat + '&longitude=' + Local.longitude + '&latitude=' + Local.latitude + '&t=' + Math.random(),
            error: function(request) {
                alert("服务器繁忙!");
                return;
            },
            success: function(data) {
                $('#get_more_load').hide();
                if (data) {
                    $('#get_more_load').before(data);
                    $('#getmore').show();
                } else {
                    $('#getmore').hide();
                }
            }
        });
    }

    // 浏览器定位API
    function getLocationApi(successCallback) {
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(successCallback, showError);
        } else {
            layer.open({content: '<i class="fa fa-exclamation-triangle"></i>&nbsp;悲催，浏览器不支持地理定位。'});
        }
    }

    function showError(error) {
        switch(error.code) {
            case error.PERMISSION_DENIED:
                layer.open({content: '<i class="fa fa-exclamation-triangle"></i>&nbsp;定位失败，用户残忍地拒绝了请求地理定位服务'});
                break;
            case error.POSITION_UNAVAILABLE:
                layer.open({content: '<i class="fa fa-exclamation-triangle"></i>&nbsp;定位失败，位置信息是不可用的'});
                break;
            case error.TIMEOUT:
                layer.open({content: '<i class="fa fa-exclamation-triangle"></i>&nbsp;定位失败，请求获取用户位置超时'});
                break;
            case error.UNKNOWN_ERROR:
                layer.open({content: '<i class="fa fa-exclamation-triangle"></i>&nbsp;定位失败，定位系统失效'});
                break;
        }
    }

    var layer_no = function(){
        layer.open({
            content: '<i class="fa fa-meh-o"></i>&nbsp;我错了，我哄你还不行吗，别生气了，嗯？',
            btn: ['再试一次', '我讨厌你'],
            yes: function(index){
                $('#positioning').click();
            },
            no: function(index){
                layer.open({
                    content: '<i class="fa fa-meh-o"></i>&nbsp;别生气了，我真的错了，我错在不乖，连给你定个位都不准，要我有什么用呢，我给你讲个笑话听好不好，不要生气了',
                    btn: ['嗯', '不听'],
                    yes: function(index){
                        layer.open({
                            content: '“小时候去动物园看老虎，看着特威风可爱，暗暗发誓长大以后一定也要养一个。20年后，这个梦想终于实现了。不说了，该给媳妇做饭去了……”',
                            btn: ['好吧，原谅你了', '一点都不好笑'],
                            yes: function(index){
                                layer.open({
                                    content: '嘻嘻，那不要生气了哦，让我再试一次好吧？',
                                    btn: ['嗯嗯', '不用了，你歇一会'],
                                    yes: function(index){
                                        $('#positioning').click();
                                    },
                                    no: function(index){
                                        layer.open({content: '那你不要生气了啊，生气对身体不好。', time:2});
                                    },
                                });
                            },
                            no: function(index){
                                layer.open({content: '<i class="fa fa-frown-o"></i>&nbsp;对不起，我错了，我面壁去了。',time:2});
                            },
                        });
                    },
                    no: function(index){
                        layer.open({content: '<i class="fa fa-frown-o"></i>&nbsp;大哭', time:2});
                    },
                });
            },
        });
    };

</script>

</body>
</html>